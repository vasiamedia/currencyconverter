# Currency Converter - currencyconverter.org

A currency converter web app built with Webflow and powered by Cloudflare Pages + Workers.

## Architecture Overview

### Webflow â†’ Git â†’ Cloudflare Pages
- **Front-end (HTML/CSS/JS)** is built in Webflow and exported to this repo
- **Static files** are served via Cloudflare Pages
- **Server-side logic** runs at the edge via Cloudflare Functions & Workers
- **Data storage** uses Cloudflare KV (cache) + D1 (database)
- **Cron jobs** run via a separate Cloudflare Worker to fetch fresh currency rates

### Deployment Flow
1. Build UI in Webflow
2. Export from Webflow
3. Drag exported files into this folder (overwrites existing)
4. Commit & push to GitHub
5. Cloudflare Pages auto-deploys

---

## âš ï¸ CRITICAL: DO NOT EDIT THESE FILES

The following files/folders are **managed by Webflow** and will be overwritten on every export:

### ğŸš« Never Touch:
- **ANY `.html` files** (index.html, template.html, style-guide.html, 401.html, 404.html, etc.)
- `/css/` (all CSS files)
- `/js/` (all JavaScript files)
- `/images/` (all images)

**Any manual edits to these files will be lost on the next Webflow export.**

---

## âœ… Safe to Edit (Cloudflare Infrastructure)

These files are **safe to modify** and won't be touched by Webflow exports:

- `.gitignore`
- `README.md`
- `package.json`
- `wrangler.toml`
- `/functions/` (Cloudflare Pages Functions)
- `/workers/` (Cloudflare Workers for cron jobs)
- `/migrations/` (D1 database schema)

---

## Project Structure

```
currencyconverter/
â”œâ”€â”€ *.html                  # ğŸš« ALL HTML files - Webflow export (DO NOT EDIT)
â”œâ”€â”€ css/                    # ğŸš« Webflow CSS (DO NOT EDIT)
â”œâ”€â”€ js/                     # ğŸš« Webflow JS (DO NOT EDIT)
â”œâ”€â”€ images/                 # ğŸš« Webflow assets (DO NOT EDIT)
â”‚
â”œâ”€â”€ README.md               # âœ… Project documentation
â”œâ”€â”€ package.json            # âœ… NPM scripts & dependencies
â”œâ”€â”€ wrangler.toml           # âœ… Cloudflare Pages config
â”œâ”€â”€ .gitignore              # âœ… Git ignore rules
â”‚
â”œâ”€â”€ functions/              # âœ… Cloudflare Pages Functions (edge middleware)
â”‚   â”œâ”€â”€ [[path]].js         # Catch-all: SSR, caching, HTML rewriting
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ rates.js        # API endpoint: /api/rates
â”‚
â”œâ”€â”€ workers/                # âœ… Cloudflare Workers (separate from Pages)
â”‚   â””â”€â”€ cron/
â”‚       â”œâ”€â”€ wrangler.toml   # Cron worker config
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ index.ts    # Scheduled job: fetch & store rates
â”‚
â””â”€â”€ migrations/             # âœ… D1 database migrations
    â””â”€â”€ 0001_init.sql       # Initial schema
```

---

## How It Works

### 1. Static Site (Webflow Export)
- All HTML/CSS/JS is generated by Webflow
- Files are served as-is by Cloudflare Pages
- No build step required

### 2. Edge Functions (`/functions/`)
- Run at the Cloudflare edge (same domain as your site)
- Intercept requests before they hit static files
- Use cases:
  - **Caching**: Edge cache for faster page loads
  - **SSR**: Dynamic meta tags for SEO (via HTMLRewriter)
  - **API**: Serve currency data from KV/D1

### 3. Cron Worker (`/workers/cron/`)
- Separate Worker that runs on a schedule
- Fetches fresh currency rates every 30 minutes
- Stores data in:
  - **KV** (fast cache, 6hr TTL)
  - **D1** (permanent historical data)

### 4. Data Flow
```
External Rate API
       â†“
   Cron Worker (every 30 min)
       â†“
   KV (cache) + D1 (database)
       â†“
   Pages Function (/api/rates)
       â†“
   Frontend (your Webflow site)
```

---

## Cloudflare Services Used

### Pages
- Hosts static site (Webflow export)
- Runs edge functions in `/functions/`
- Auto-deploys from GitHub

### Workers
- Runs scheduled cron jobs
- Fetches & processes currency data

### KV (Key-Value Store)
- Fast edge cache for latest rates
- 6-hour expiration
- Read from `/api/rates` endpoint

### D1 (SQL Database)
- Permanent storage for historical rates
- Queryable for trends/charts
- Fallback when KV is empty

---

## Setup Steps (In Order)

### 1. Initialize Git & Push to GitHub
```bash
git init
git add .
git commit -m "Initial Webflow export"
# Create repo on GitHub, then:
git remote add origin git@github.com:YOUR_USERNAME/currencyconverter.git
git push -u origin main
```

### 2. Install Dependencies
```bash
npm install
```

### 3. Create Cloudflare Resources
```bash
# Create KV namespace
npx wrangler kv:namespace create CURRENCY_RATES
# â†’ Copy the ID into wrangler.toml

# Create D1 database
npx wrangler d1 create currencyconverter
# â†’ Copy the database_id into wrangler.toml

# Run migrations
npm run d1:migrate
```

### 4. Connect to Cloudflare Pages
- Go to Cloudflare Dashboard â†’ Pages â†’ Create project
- Connect to GitHub repo
- Settings:
  - Build command: (leave empty)
  - Build output directory: `.`
- Add bindings in Settings â†’ Functions:
  - KV: `CURRENCY_RATES`
  - D1: `DB`
- Deploy

### 5. Deploy Cron Worker
```bash
npm run deploy:cron
```

### 6. Add Custom Domain
- Cloudflare Pages â†’ Custom domains â†’ Add `currencyconverter.org`

---

## NPM Scripts

```bash
npm run dev              # Local dev server (Pages + Functions)
npm run deploy:pages     # Deploy Pages (or just push to GitHub)
npm run deploy:cron      # Deploy cron Worker
npm run d1:migrate       # Apply database migrations
```

---

## Environment Variables

### Pages (set in Cloudflare Dashboard)
- `SITE_ORIGIN` - Your site's canonical URL (e.g., `https://currencyconverter.org`)

### Cron Worker (set in Cloudflare Dashboard)
- `RATES_BASES` - Comma-separated list of base currencies (e.g., `USD,EUR,GBP,JPY`)

---

## API Endpoints

### `GET /api/rates?base=USD`
Returns latest currency rates for the specified base currency.

**Response:**
```json
{
  "source": "kv",
  "base": "USD",
  "rates": {
    "EUR": 0.92,
    "GBP": 0.79,
    ...
  },
  "at": "2025-10-03T12:00:00.000Z"
}
```

---

## Modifying the Site

### To Change UI/Design
1. Edit in Webflow
2. Export from Webflow
3. Drag files into this folder (overwrite)
4. Commit & push to GitHub

### To Change Server Logic
1. Edit files in `/functions/` or `/workers/`
2. Commit & push to GitHub (Pages auto-deploys)
3. For cron worker: `npm run deploy:cron`

### To Add Dynamic SEO (Without Editing HTML)
- Use `HTMLRewriter` in `/functions/[[path]].js`
- Rewrites HTML on the fly at the edge
- Example: inject meta tags based on URL

---

## Important Notes

- **Never commit `.dev.vars`** (contains secrets for local dev)
- **KV bindings** must match in both `wrangler.toml` files
- **D1 bindings** must match in both `wrangler.toml` files
- **Cron schedule** is set in `workers/cron/wrangler.toml` (default: every 30 min)
- **Rate API** is exchangerate.host (free tier) - can be swapped out

---

## Troubleshooting

### "KV/D1 binding not found"
- Make sure IDs in `wrangler.toml` match actual resource IDs
- Check Cloudflare Dashboard â†’ Pages â†’ Settings â†’ Functions â†’ Bindings

### "Cron not running"
- Verify Worker is deployed: `npm run deploy:cron`
- Check logs in Cloudflare Dashboard â†’ Workers â†’ Logs

### "API returns empty data"
- Run cron manually in Dashboard to populate KV/D1
- Check cron Worker logs for errors

---

## Next Steps

1. âœ… Set up Git + GitHub
2. âœ… Add Cloudflare config files
3. âœ… Create KV + D1 resources
4. âœ… Connect repo to Cloudflare Pages
5. âœ… Deploy cron Worker
6. ğŸ”² Wire up frontend to `/api/rates`
7. ğŸ”² Add dynamic SEO with HTMLRewriter
8. ğŸ”² Set up analytics/monitoring

---

## Resources

- [Cloudflare Pages Docs](https://developers.cloudflare.com/pages/)
- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare KV Docs](https://developers.cloudflare.com/kv/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)
- [Wrangler CLI Docs](https://developers.cloudflare.com/workers/wrangler/)

---

**Last Updated:** October 3, 2025

