# Currency Converter - currencyconverter.org

A currency converter web app built with Webflow and powered by Cloudflare Pages + Workers.

## Architecture Overview

### Webflow → Git → Cloudflare Pages
- **Front-end (HTML/CSS/JS)** is built in Webflow and exported to this repo
- **Static files** are served via Cloudflare Pages
- **Server-side logic** runs at the edge via Cloudflare Functions & Workers
- **Data storage** uses Cloudflare KV (cache) + D1 (database)
- **Cron jobs** run via a separate Cloudflare Worker to fetch fresh currency rates

### Deployment Flow
1. Build UI in Webflow
2. Export from Webflow
3. Drag exported files into this folder (overwrites existing)
4. Commit & push to GitHub
5. Cloudflare Pages auto-deploys

---

## ⚠️ CRITICAL: DO NOT EDIT THESE FILES

The following files/folders are **managed by Webflow** and will be overwritten on every export:

### 🚫 Never Touch:
- **ANY `.html` files** (index.html, template.html, style-guide.html, 401.html, 404.html, etc.)
- `/css/` (all CSS files)
- `/js/` (all JavaScript files)
- `/images/` (all images)

**Any manual edits to these files will be lost on the next Webflow export.**

### ⚡ JavaScript Injection Rule
**NEVER add JavaScript to Webflow files.** All interactivity must be injected via Cloudflare Pages Functions using HTMLRewriter. This keeps Webflow exports pristine and allows full control at the edge without touching source files.

---

## ✅ Safe to Edit (Cloudflare Infrastructure)

These files are **safe to modify** and won't be touched by Webflow exports:

- `.gitignore`
- `README.md`
- `SETUP_STATUS.md`
- `package.json`
- `wrangler.toml`
- `/functions/` (Cloudflare Pages Functions - all JS injection happens here)
- `/workers/` (Cloudflare Workers for cron jobs)

---

## Project Structure

```
currencyconverter/
├── *.html                  # 🚫 ALL HTML files - Webflow export (DO NOT EDIT)
├── css/                    # 🚫 Webflow CSS (DO NOT EDIT)
├── js/                     # 🚫 Webflow JS (DO NOT EDIT)
├── images/                 # 🚫 Webflow assets (DO NOT EDIT)
│
├── README.md               # ✅ Project documentation
├── SETUP_STATUS.md         # ✅ Current setup status
├── package.json            # ✅ NPM scripts & dependencies
├── wrangler.toml           # ✅ Cloudflare Pages config + KV binding
├── .gitignore              # ✅ Git ignore rules
│
├── functions/              # ✅ Cloudflare Pages Functions (edge middleware)
│   ├── index.js            # Homepage: inject convert button script
│   ├── [[path]].js         # Catch-all: edge caching
│   ├── api/
│   │   ├── rate.js         # GET /api/rate?from=X&to=Y (plain text)
│   │   └── rates.js        # GET /api/rates?base=USD (JSON)
│   └── [from]-to-[to]/
│       └── [[amount]].js   # Dynamic routes: /usd-to-eur or /usd-to-eur/1000
│
└── workers/                # ✅ Cloudflare Workers (separate from Pages)
    └── cron/               # Future: auto-update rates every 30 min
        ├── wrangler.toml
        └── src/index.ts
```

---

## How It Works

### 1. Static Site (Webflow Export)
- All HTML/CSS is generated by Webflow
- **NO JavaScript in Webflow files** - all JS injected at the edge
- Files are served as-is by Cloudflare Pages
- No build step required

### 2. Edge Functions (`/functions/`)
Run at the Cloudflare edge before serving static files:

**Homepage (`/functions/index.js`)**
- Injects convert button script into `index.html`
- Handles form submission → navigation to `/usd-to-eur/1000`

**Dynamic Routes (`/functions/[from]-to-[to]/[[amount]].js`)**
- Handles `/usd-to-eur` or `/usd-to-eur/1000` format
- Server-side renders conversion using `template.html`
- Calculates cross-rates: `USD/TO ÷ USD/FROM`
- Injects rate into `<head>` as `window.__RATE__`
- Injects client script for amount updates (no reload)
- SEO-friendly meta tags

**API Endpoints**
- `/api/rate?from=USD&to=EUR` - Returns plain text rate
- `/api/rates?base=USD` - Returns full JSON object

**Edge Caching (`/functions/[[path]].js`)**
- Caches all HTML responses at the edge
- 5 min browser cache, 1 hour edge cache

### 3. Smart UX (No Full-Page Reload)
- **Currency select change**: Reloads page (new SSR with fresh rate)
- **Amount blur/Enter**: Updates inline using `window.__RATE__` (no reload)
- **URL updates**: `history.replaceState` keeps URL in sync

### 4. Data Flow
```
KV: usd-rates
     ↓
Edge Function (calculates cross-rate)
     ↓
SSR with HTMLRewriter (injects rate + script)
     ↓
Browser (amount changes use stored rate)
```

---

## Cloudflare Services Used

### Pages
- Hosts static site (Webflow export)
- Runs edge functions in `/functions/`
- Auto-deploys from GitHub on push to main
- Serves dynamic routes via Functions

### KV (Key-Value Store)
- Namespace ID: `a323de077aa54d53b572ac835bf77aa4`
- Key: `usd-rates` (JSON with all USD-based rates)
- Fast edge cache, globally distributed
- Read from Pages Functions for conversions

### Workers (Future)
- Cron worker structure ready in `/workers/cron/`
- Can auto-update KV with fresh rates every 30 minutes
- Not currently deployed

---

## Setup Steps (In Order)

### 1. Initialize Git & Push to GitHub
```bash
git init
git add .
git commit -m "Initial Webflow export"
# Create repo on GitHub, then:
git remote add origin git@github.com:YOUR_USERNAME/currencyconverter.git
git push -u origin main
```

### 2. Install Dependencies
```bash
npm install
```

### 3. Create Cloudflare Resources
```bash
# Create KV namespace
npx wrangler kv:namespace create CURRENCY_RATES
# → Copy the ID into wrangler.toml

# Create D1 database
npx wrangler d1 create currencyconverter
# → Copy the database_id into wrangler.toml

# Run migrations
npm run d1:migrate
```

### 4. Connect to Cloudflare Pages
- Go to Cloudflare Dashboard → Pages → Create project
- Connect to GitHub repo
- Settings:
  - Build command: (leave empty)
  - Build output directory: `.`
- Add bindings in Settings → Functions:
  - KV: `CURRENCY_RATES`
  - D1: `DB`
- Deploy

### 5. Deploy Cron Worker
```bash
npm run deploy:cron
```

### 6. Add Custom Domain
- Cloudflare Pages → Custom domains → Add `currencyconverter.org`

---

## NPM Scripts

```bash
npm run dev              # Local dev server (Pages + Functions)
npm run deploy:pages     # Deploy Pages (or just push to GitHub)
npm run deploy:cron      # Deploy cron Worker
npm run d1:migrate       # Apply database migrations
```

---

## Environment Variables

### Pages (set in Cloudflare Dashboard)
- `SITE_ORIGIN` - Your site's canonical URL (e.g., `https://currencyconverter.org`)

### Cron Worker (set in Cloudflare Dashboard)
- `RATES_BASES` - Comma-separated list of base currencies (e.g., `USD,EUR,GBP,JPY`)

---

## API Endpoints

### `GET /api/rates?base=USD`
Returns latest currency rates for the specified base currency.

**Response:**
```json
{
  "source": "kv",
  "base": "USD",
  "rates": {
    "EUR": 0.92,
    "GBP": 0.79,
    ...
  },
  "at": "2025-10-03T12:00:00.000Z"
}
```

---

## Modifying the Site

### To Change UI/Design
1. Edit in Webflow
2. Export from Webflow
3. Drag files into this folder (overwrite)
4. Commit & push to GitHub

### To Change Server Logic
1. Edit files in `/functions/` or `/workers/`
2. Commit & push to GitHub (Pages auto-deploys)
3. For cron worker: `npm run deploy:cron`

### To Add Dynamic SEO (Without Editing HTML)
- Use `HTMLRewriter` in `/functions/[[path]].js`
- Rewrites HTML on the fly at the edge
- Example: inject meta tags based on URL

---

## Important Notes

- **Never commit `.dev.vars`** (contains secrets for local dev)
- **KV bindings** must match in both `wrangler.toml` files
- **D1 bindings** must match in both `wrangler.toml` files
- **Cron schedule** is set in `workers/cron/wrangler.toml` (default: every 30 min)
- **Rate API** is exchangerate.host (free tier) - can be swapped out

---

## Troubleshooting

### "KV/D1 binding not found"
- Make sure IDs in `wrangler.toml` match actual resource IDs
- Check Cloudflare Dashboard → Pages → Settings → Functions → Bindings

### "Cron not running"
- Verify Worker is deployed: `npm run deploy:cron`
- Check logs in Cloudflare Dashboard → Workers → Logs

### "API returns empty data"
- Run cron manually in Dashboard to populate KV/D1
- Check cron Worker logs for errors

---

## Next Steps

1. ✅ Set up Git + GitHub
2. ✅ Add Cloudflare config files
3. ✅ Create KV + D1 resources
4. ✅ Connect repo to Cloudflare Pages
5. ✅ Deploy cron Worker
6. 🔲 Wire up frontend to `/api/rates`
7. 🔲 Add dynamic SEO with HTMLRewriter
8. 🔲 Set up analytics/monitoring

---

## Resources

- [Cloudflare Pages Docs](https://developers.cloudflare.com/pages/)
- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare KV Docs](https://developers.cloudflare.com/kv/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)
- [Wrangler CLI Docs](https://developers.cloudflare.com/workers/wrangler/)

---

**Last Updated:** October 3, 2025

